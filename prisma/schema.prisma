// Prisma Schema for Arcle Savings/SafeLock System
// 
// To activate:
// 1. Install Prisma: npm install prisma @prisma/client
// 2. Set DATABASE_URL in .env: DATABASE_URL="postgresql://user:password@localhost:5432/arcle"
// 3. Run migration: npx prisma migrate dev --name init
// 4. Generate client: npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String?  @unique
  walletId  String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  goals         SavingsGoal[]
  safelocks     SafeLock[]
  notifications Notification[]
  sessions      Session[]
  accounts      Account[]

  @@index([walletId])
  @@index([email])
}

// ============================================
// NextAuth.js Models (for authentication)
// ============================================

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Savings Goals
// ============================================

model SavingsGoal {
  id                    String   @id @default(uuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId              String
  
  // Goal details
  goalName              String
  goalCategory          String   // house, car, vacation, wedding, emergency, education, custom
  targetAmount          Decimal  @db.Decimal(18, 6)
  currentAmount         Decimal  @db.Decimal(18, 6)
  
  // Contribution settings
  contributionAmount    Decimal? @db.Decimal(18, 6)
  contributionFrequency String?  // daily, weekly, monthly, one-time
  autoDeduct            Boolean  @default(false)
  
  // Lock and penalty settings
  lockPeriod            Int      // days
  penaltyRate           Decimal  @db.Decimal(5, 2) // percentage
  bonusAPY              Decimal  @db.Decimal(5, 2) // percentage
  
  // Timestamps
  createdAt             DateTime @default(now())
  maturityDate          DateTime
  lastContributionAt    DateTime?
  nextContributionAt    DateTime?
  updatedAt             DateTime @updatedAt
  
  // Status
  status                String   @default("active") // active, matured, broken
  reminderEnabled       Boolean  @default(true)
  
  // Relations
  transactions          SavingsTransaction[]

  @@index([userId])
  @@index([walletId])
  @@index([status])
  @@index([nextContributionAt])
  @@index([maturityDate])
}

// ============================================
// SafeLock (Fixed Deposits)
// ============================================

model SafeLock {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId        String
  
  // Lock details
  amount          Decimal  @db.Decimal(18, 6)
  lockPeriod      Int      // days
  apy             Decimal  @db.Decimal(5, 2) // percentage
  penaltyRate     Decimal  @db.Decimal(5, 2) // percentage
  
  // Timestamps
  createdAt       DateTime @default(now())
  maturityDate    DateTime
  updatedAt       DateTime @updatedAt
  
  // Status
  status          String   @default("locked") // locked, matured, broken
  
  // Blockchain
  transactionHash String?
  
  @@index([userId])
  @@index([walletId])
  @@index([status])
  @@index([maturityDate])
}

// ============================================
// Savings Transactions
// ============================================

model SavingsTransaction {
  id           String      @id @default(uuid())
  goalId       String
  goal         SavingsGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type         String      // deposit, withdrawal, maturity, penalty
  amount       Decimal     @db.Decimal(18, 6)
  balanceAfter Decimal     @db.Decimal(18, 6)
  
  // Timestamps
  timestamp    DateTime    @default(now())
  
  // Blockchain
  txHash       String?
  
  @@index([goalId])
  @@index([timestamp])
}

// ============================================
// Notifications
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification details
  type      String   // goal_matured, contribution_due, low_balance, goal_progress, safelock_matured
  title     String
  message   String
  data      Json?    // Additional data (goal name, amount, etc.)
  
  // Status
  read      Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  readAt    DateTime?
  
  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

// ============================================
// Pending Contributions (for retry logic)
// ============================================

model PendingContribution {
  id             String   @id @default(uuid())
  goalId         String
  userId         String
  amount         Decimal  @db.Decimal(18, 6)
  
  // Retry logic
  attempts       Int      @default(0)
  maxAttempts    Int      @default(3)
  lastAttemptAt  DateTime?
  nextRetryAt    DateTime
  
  // Status
  status         String   @default("pending") // pending, processing, completed, failed
  errorMessage   String?
  
  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([nextRetryAt])
  @@index([status])
}

// ============================================
// Maturity Alerts (for scheduled checks)
// ============================================

model MaturityAlert {
  id           String   @id @default(uuid())
  goalId       String?
  safelockId   String?
  userId       String
  type         String   // goal or safelock
  maturityDate DateTime
  alerted      Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  @@index([maturityDate])
  @@index([alerted])
}



